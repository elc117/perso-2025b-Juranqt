<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Campeonatos</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; }
    .container { background: #fff; border: 4px solid #e3e6f5; padding: 24px; margin: 32px auto; width: 700px; border-radius: 8px; }
    .form-row { display: flex; align-items: center; margin-bottom: 12px; }
    .form-row label { width: 110px; }
    .form-row input, .form-row select { margin-right: 12px; padding: 4px; }
    .form-row .small-label { width: 70px; }
    .form-row .quantidade { margin-left: 110px; }
    .form-row .mesa-quadra { margin-left: 110px; }
    .actions { margin-bottom: 18px; }
    table { width: 100%; border-collapse: collapse; margin-top: 18px; background: #fff; }
    th, td { border: 1px solid #d1d1d1; padding: 8px; text-align: center; }
    th { background: #e3e6f5; }
    tr:nth-child(even) { background: #f7f7f7; }
    .btn { padding: 4px 10px; margin: 0 2px; border: none; border-radius: 4px; cursor: pointer; }
    .btn-edit { background: #ffe066; }
    .btn-delete { background: #ff6b6b; color: #fff; }
    .btn-add { background: #4ecdc4; color: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <form id="form-campeonato">
      <div class="form-row">
        <label for="campeonato">Campeonato:</label>
        <select id="campeonato">
          <option value="">Selecione</option>
        </select>
        <button type="button" class="btn btn-add" onclick="addCampeonato()">+</button>
        <label for="data" class="small-label">Data:</label>
        <input type="date" id="data">
        <label for="local" class="small-label">Local:</label>
        <select id="local">
          <option value="">Selecione</option>
        </select>
        <button type="button" class="btn btn-add" onclick="addLocal()">+</button>
      </div>
      <div class="form-row quantidade">
        <span>Quantidade</span>
      </div>
      <div class="form-row mesa-quadra">
        <label for="posicao">Posição:</label>
        <label for="quadra" class="small-label">Quadra:</label>
        <select id="quadra"></select>
        <label for="mesa" class="small-label">Mesa:</label>
        <select id="mesa"></select>
      </div>
      <div class="actions">
        <button type="submit" class="btn btn-add">Cadastrar</button>
      </div>
    </form>
    <table id="tabela-campeonatos">
    <div style="margin-bottom: 16px;">
      <label for="filtro-mes">Filtrar por mês:</label>
      <select id="filtro-mes" onchange="filtrarPorMes()">
        <option value="">Todos</option>
        <option value="01">01</option>
        <option value="02">02</option>
        <option value="03">03</option>
        <option value="04">04</option>
        <option value="05">05</option>
        <option value="06">06</option>
        <option value="07">07</option>
        <option value="08">08</option>
        <option value="09">09</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
      </select>
    </div>
      <thead>
        <tr>
          <th>Campeonato</th>
          <th>Data</th>
          <th>Local</th>
          <th>Mesa</th>
          <th>Quadra</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        <!-- Linhas serão inseridas aqui -->
      </tbody>
    </table>
  </div>
  <script>
    let campeonatos = [];
  let campeonatosFiltrados = [];
    let editId = null;

    function preencherQuadraMesa() {
      const quadra = document.getElementById('quadra');
      const mesa = document.getElementById('mesa');
      quadra.innerHTML = '';
      mesa.innerHTML = '';
      for (let i = 0; i <= 10; i++) {
        const qOpt = document.createElement('option');
        qOpt.value = i;
        qOpt.text = i;
        quadra.appendChild(qOpt);
        const mOpt = document.createElement('option');
        mOpt.value = i;
        mOpt.text = i;
        mesa.appendChild(mOpt);
      }
      quadra.value = 0;
      mesa.value = 0;
    }

    function preencherLocalCampeonato() {
      document.getElementById('campeonato').innerHTML = '<option value="">Selecione</option>';
      document.getElementById('local').innerHTML = '<option value="">Selecione</option>';
    }

    function carregarCampeonatos() {
      fetch('/campeonatos')
        .then(r => r.json())
        .then(data => {
          campeonatos = data;
          filtrarPorMes();
        });
    }

    window.addEventListener('DOMContentLoaded', function() {
      preencherQuadraMesa();
      preencherLocalCampeonato();
      carregarCampeonatos();
    });

    document.getElementById('form-campeonato').addEventListener('submit', function(e) {
      e.preventDefault();
      const campeonato = document.getElementById('campeonato').value;
      const dataCampo = document.getElementById('data').value;
      const local = document.getElementById('local').value;
      const quadra = document.getElementById('quadra').value;
      const mesa = document.getElementById('mesa').value;
      const novo = { campeonato, dataCampo, local, mesa, quadra };
      if (editId !== null) {
  fetch(`/campeonatos/${editId}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(novo)
        }).then(() => {
          editId = null;
          document.getElementById('form-campeonato').reset();
          carregarCampeonatos();
        });
      } else {
  fetch('/campeonatos', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(novo)
        }).then(() => {
          document.getElementById('form-campeonato').reset();
          carregarCampeonatos();
        });
      }
    });

    function addCampeonato() {
    }

    window.addCampeonato = function() {
      const nome = prompt('Nome do novo campeonato:');
      if (nome) {
        const select = document.getElementById('campeonato');
        const option = document.createElement('option');
        option.text = nome;
        option.value = nome;
        select.add(option);
        select.value = nome;
      }
    }

    function addLocal() {
    }

    window.addLocal = function() {
      const nome = prompt('Nome do novo local:');
      if (nome) {
        const select = document.getElementById('local');
        const option = document.createElement('option');
        option.text = nome;
        option.value = nome;
        select.add(option);
        select.value = nome;
      }
    }

    function renderTabela() {
      const tbody = document.getElementById('tabela-campeonatos').querySelector('tbody');
      tbody.innerHTML = '';
      // Ordena por data crescente (YYYY-MM-DD)
      const listaOrdenada = [...campeonatosFiltrados].sort((a, b) => {
        if (!a.dataCampo) return -1;
        if (!b.dataCampo) return 1;
        return a.dataCampo.localeCompare(b.dataCampo);
      });
      listaOrdenada.forEach((c) => {
        const tr = document.createElement('tr');
        // Formata data para DD-MM-YYYY
        let dataFormatada = c.dataCampo;
        if (c.dataCampo && c.dataCampo.split('-').length === 3) {
          const partes = c.dataCampo.split('-');
          dataFormatada = `${partes[2]}-${partes[1]}-${partes[0]}`;
        }
        tr.innerHTML = `
          <td>${c.campeonato}</td>
          <td>${dataFormatada}</td>
          <td>${c.local}</td>
          <td>${c.mesa}</td>
          <td>${c.quadra}</td>
          <td>
            <button class='btn btn-edit' onclick='editar(${c.campeonatoId})'>Editar</button>
            <button class='btn btn-delete' onclick='excluir(${c.campeonatoId})'>Excluir</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    window.editar = function(id) {
      const c = campeonatos.find(x => x.campeonatoId === id);
      const campeonatoSelect = document.getElementById('campeonato');
      const localSelect = document.getElementById('local');
      // Adiciona opção se não existir
      if (![...campeonatoSelect.options].some(opt => opt.value === c.campeonato)) {
        const opt = document.createElement('option');
        opt.value = c.campeonato;
        opt.text = c.campeonato;
        campeonatoSelect.add(opt);
      }
      if (![...localSelect.options].some(opt => opt.value === c.local)) {
        const opt = document.createElement('option');
        opt.value = c.local;
        opt.text = c.local;
        localSelect.add(opt);
      }
      campeonatoSelect.value = c.campeonato;
      document.getElementById('data').value = c.dataCampo;
      localSelect.value = c.local;
      document.getElementById('quadra').value = c.quadra;
      document.getElementById('mesa').value = c.mesa;
      editId = id;
    }

    window.filtrarPorMes = function() {
      const mes = document.getElementById('filtro-mes').value;
      if (!mes) {
        campeonatosFiltrados = campeonatos;
      } else {
        campeonatosFiltrados = campeonatos.filter(c => {
          // dataCampo no formato YYYY-MM-DD
          const partes = c.dataCampo.split('-');
          if (partes.length !== 3) return false;
          const ano = partes[0];
          const mesCampo = partes[1];
          const dia = partes[2];
          // mês anterior
          let mesAnterior = (parseInt(mes) - 1).toString().padStart(2, '0');
          let anoAnterior = ano;
          if (mesAnterior === '00') {
            mesAnterior = '12';
            anoAnterior = (parseInt(ano) - 1).toString();
          }
          // datas limite
          const dataInicio = `${anoAnterior}-${mesAnterior}-28`;
          const dataFim = `${ano}-${mes}-27`;
          const dataAtual = `${ano}-${mesCampo}-${dia}`;
          return dataAtual >= dataInicio && dataAtual <= dataFim;
        });
      }
      renderTabela();
    }

    window.excluir = function(id) {
      if (confirm('Deseja excluir este registro?')) {
  fetch(`/campeonatos/${id}`, { method: 'DELETE' })
          .then(() => carregarCampeonatos());
      }
    };
  </script>
</body>
</html>